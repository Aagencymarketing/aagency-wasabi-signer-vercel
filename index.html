<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gestione Video clienti Aagency</title>
  <style>
    body {font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #fff; color: #222;}
    .wrap {max-width: 1100px; margin: 20px auto; padding: 0 15px;}
    h1 {margin: 0; font-size: 24px;}
    .sub {margin: 5px 0 20px; color: #555;}
    .btn {background: #000; color: #fff; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; line-height:1;}
    .btn:hover {background: #111;}
    .btn-danger {background: #b00020;}
    .btn-danger:hover {background: #8a0019;}
    .btn-muted {background: #444;}
    .field {padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; min-height:44px;}
    .row {display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;}
    .pillbar {display: flex; gap: 6px; align-items: center; flex-wrap: wrap;}
    .pill {padding: 7px 12px; border: 1px solid #ddd; border-radius: 999px; background: #f7f7f7; cursor: pointer;}
    .pill.active {background: #000; color: #fff; border-color: #000;}
    .card {border: 1px solid #eee; border-radius: 10px; padding: 12px;}
    .muted {color: #666; font-size: 13px;}
    .dropzone {flex: 1; min-height: 120px; border: 2px dashed #bbb; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-align: center;}
    .dropzone.drag {border-color: #999;}
    .tablewrap {overflow: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; margin-top: 10px;}
    table {width: 100%; border-collapse: collapse; min-width: 720px;}
    th, td {padding: 8px; border-bottom: 1px solid #eee; text-align: left;}
    th {background: #fafafa;}
    tbody tr:nth-child(odd) {background: #fafafa;}
    @media (max-width: 760px) {
      .row {flex-direction: column; align-items: stretch;}
      .btn, .field {width: 100%;}
      .dropzone {min-height: 100px;}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="row" style="justify-content: space-between; align-items: flex-start;">
    <div>
      <h1>Gestione Video dei clienti Aagency</h1>
      <div class="sub">Carica, organizza e gestisci i file per ogni cliente e cartella.</div>
    </div>
    <button id="toggleHelp" class="btn">❓ Guida</button>
  </div>

  <div id="helpPanel" class="card" style="display:none; margin-bottom:15px;">
    <div style="font-weight:600; margin-bottom:6px;">Come funziona</div>
    <ol style="margin:0; padding-left:20px; line-height:1.5;">
      <li>Scegli o crea un cliente.</li>
      <li>Seleziona la cartella (Da editare / Da programmare / Archivio).</li>
      <li>Trascina i file o clicca "Scegli file", poi "Avvia upload".</li>
      <li>Scarica o elimina file singoli o multipli dalla libreria.</li>
    </ol>
  </div>

  <div class="row">
    <input id="client" list="clienti" placeholder="Seleziona cliente..." class="field" style="min-width:280px;">
    <datalist id="clienti"></datalist>
    <button id="createClient" class="btn">Crea Cliente</button>
    <button id="deleteClient" class="btn btn-danger">Elimina Cliente</button>
    <div class="pillbar">
      <div class="pill active" data-sub="VIDEO_DA_EDITARE/">Da editare</div>
      <div class="pill" data-sub="VIDEO_DA_PROGRAMMARE/">Da programmare</div>
      <div class="pill" data-sub="ARCHIVIO/">Archivio</div>
    </div>
  </div>

  <div class="row">
    <div id="dropzone" class="dropzone">
      <div>
        <div style="font-weight:600;">Trascina qui i file</div>
        <div class="muted">oppure</div>
        <label class="btn" style="margin-top:6px;">Scegli file
          <input type="file" id="file" multiple style="display:none;">
        </label>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; gap:8px; width:220px;">
      <button id="startUpload" class="btn">Avvia upload</button>
      <span id="status" style="color:#070;"></span>
    </div>
  </div>

  <div id="queue" class="card" style="display:none; margin-top:10px;">
    <div style="font-weight:600; margin-bottom:6px;">Coda upload</div>
    <div id="queueList" style="display:flex; flex-direction:column; gap:8px;"></div>
  </div>

  <div class="row" style="margin-top:15px;">
    <label style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="selectAll"> Seleziona tutto
    </label>
    <button id="bulkDownload" class="btn">Scarica selezionati</button>
    <button id="bulkDelete" class="btn btn-danger">Elimina selezionati</button>
  </div>

  <div id="list" class="tablewrap"></div>

</div>

<script>
  // >>>> FISSO: usa SEMPRE il dominio Vercel del backend (non window.location.origin)
  const SIGNER_BASE = "https://aagency-wasabi-signer-vercel.vercel.app"; // <-- METTI IL TUO se diverso
  const TOKEN = "aagencysocialmediagiavide23";
  const ROOT = "Aagency_GestioneVideo/";

  const H = {"x-agency-token": TOKEN};
  const HJSON = {"x-agency-token": TOKEN, "Content-Type":"application/json"};
  const clientEl = document.getElementById("client");
  const datalist = document.getElementById("clienti");
  const listEl = document.getElementById("list");
  const statusEl = document.getElementById("status");
  const selectAllEl = document.getElementById("selectAll");
  const bulkDlBtn = document.getElementById("bulkDownload");
  const bulkDelBtn = document.getElementById("bulkDelete");
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("file");
  const queueWrap = document.getElementById("queue");
  const queueList = document.getElementById("queueList");
  let queue = [];
  let currentSub = "VIDEO_DA_EDITARE/";

  document.getElementById("toggleHelp").onclick = () => {
    const p = document.getElementById("helpPanel");
    p.style.display = p.style.display === "none" ? "block" : "none";
  };

  document.querySelectorAll(".pill").forEach(p => {
    p.onclick = () => {
      document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      currentSub = p.dataset.sub;
      listFiles();
    };
  });

  async function loadClients() {
    const res = await fetch(`${SIGNER_BASE}/api/list?prefix=${encodeURIComponent(ROOT)}`, {headers:H});
    const data = await res.json();
    const opts = (data.CommonPrefixes||[]).map(p=>p.Prefix.replace(ROOT,"").replace(/\/$/,"")).filter(Boolean).sort((a,b)=>a.localeCompare(b,'it'));
    datalist.innerHTML = opts.map(o=>`<option value="${o}">`).join("");
  }

  async function listFiles() {
    const c = clientEl.value.trim();
    if(!c) { listEl.innerHTML = "<div class='muted'>Nessun cliente selezionato</div>"; return; }
    listEl.innerHTML = "Carico...";
    const pref = `${ROOT}${c}/${currentSub}`;
    const res = await fetch(`${SIGNER_BASE}/api/list?prefix=${encodeURIComponent(pref)}`, {headers:H});
    const data = await res.json();
    const files = (data.Contents||[])
      .filter(f=>!f.Key.endsWith("/.keep"))
      .map(f=>({
        name: f.Key.replace(pref,""),
        size: (f.Size/1024/1024).toFixed(2),
        key: f.Key,
        date: new Date(f.LastModified).toLocaleString()
      }));
    if(!files.length){ listEl.innerHTML="<div class='muted'>Nessun file trovato</div>"; return; }
    const rows = files.map(f=>`
      <tr>
        <td style="width:30px"><input type="checkbox" class="rowSel" data-key="${encodeURIComponent(f.key)}"></td>
        <td>${f.name}</td>
        <td style="text-align:right">${f.size} MB</td>
        <td>${f.date}</td>
        <td style="text-align:right">
          <button class="btn btn-sm" data-dl="${encodeURIComponent(f.key)}">Scarica</button>
          <button class="btn btn-danger btn-sm" data-del="${encodeURIComponent(f.key)}">Elimina</button>
        </td>
      </tr>`).join("");
    listEl.innerHTML = `<div class="tablewrap"><table><thead><tr>
      <th></th><th>Nome</th><th>MB</th><th>Ultima modifica</th><th>Azioni</th>
    </tr></thead><tbody>${rows}</tbody></table></div>`;

    // attach actions
    document.querySelectorAll('[data-dl]').forEach(b=> b.onclick = () => singleDownload(decodeURIComponent(b.dataset.dl)));
    document.querySelectorAll('[data-del]').forEach(b=> b.onclick = () => singleDelete(decodeURIComponent(b.dataset.del)));
  }

  async function singleDownload(key){
    const u = new URL(`${SIGNER_BASE}/api/presign-get`); u.searchParams.set("key", key);
    const d = await fetch(u, {headers:H}).then(r=>r.json());
    if(d.url){ window.open(d.url, "_blank"); }
  }

  async function singleDelete(key){
    if(!confirm("Eliminare questo file?")) return;
    const u = new URL(`${SIGNER_BASE}/api/delete`); u.searchParams.set("key", key);
    await fetch(u, {method:"DELETE", headers:H});
    listFiles();
  }

  document.getElementById("createClient").onclick = async () => {
    const c = clientEl.value.trim();
    if(!c) return alert("Inserisci il nome cliente");

    const r = await fetch(`${SIGNER_BASE}/api/create-client`, {
      method:"POST", headers:HJSON, body: JSON.stringify({client:c, root:ROOT})
    }).then(x=>x.json()).catch(()=>null);

    if(!r || r.ok !== true) { alert("Errore creazione cliente"); return; }

    await loadClients();
    // forza subito la vista “Da editare”
    document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
    document.querySelector('.pill[data-sub="VIDEO_DA_EDITARE/"]').classList.add("active");
    currentSub = "VIDEO_DA_EDITARE/";
    await listFiles();
    alert("Cliente creato ✅");
  };

  document.getElementById("deleteClient").onclick = async () => {
    const c = clientEl.value.trim();
    if(!c) return alert("Inserisci il nome cliente");
    if(!confirm(`Eliminare TUTTI i file del cliente ${c}?`)) return;
    const r = await fetch(`${SIGNER_BASE}/api/delete-client`, {method:"POST", headers:HJSON, body: JSON.stringify({client:c, root:ROOT})}).then(x=>x.json()).catch(()=>null);
    if(!r || r.ok !== true){ alert("Errore eliminazione cliente"); return; }
    await loadClients();
    listEl.innerHTML = "";
    alert("Cliente eliminato ✅");
  };

  selectAllEl.onchange = () => {
    document.querySelectorAll(".rowSel").forEach(cb => cb.checked = selectAllEl.checked);
  };

  bulkDlBtn.onclick = async () => {
    const keys = [...document.querySelectorAll(".rowSel:checked")].map(cb=>decodeURIComponent(cb.dataset.key));
    for(const k of keys){ await singleDownload(k); }
  };

  bulkDelBtn.onclick = async () => {
    const keys = [...document.querySelectorAll(".rowSel:checked")].map(cb=>decodeURIComponent(cb.dataset.key));
    if(!keys.length) return;
    if(!confirm(`Eliminare ${keys.length} file?`)) return;
    for(const k of keys){
      const u = new URL(`${SIGNER_BASE}/api/delete`); u.searchParams.set("key", k);
      await fetch(u, {method:"DELETE", headers:H});
    }
    listFiles();
  };

  dropzone.addEventListener("dragover", e => {e.preventDefault(); dropzone.classList.add("drag");});
  dropzone.addEventListener("dragleave", ()=> dropzone.classList.remove("drag"));
  dropzone.addEventListener("drop", e => {
    e.preventDefault(); dropzone.classList.remove("drag");
    handleFiles(e.dataTransfer.files);
  });
  fileInput.onchange = () => handleFiles(fileInput.files);

  function handleFiles(files){
    const c = clientEl.value.trim(); if(!c) return alert("Seleziona un cliente");
    if(!files.length) return;
    queueWrap.style.display = "block";
    for(const f of files){
      const id = Math.random().toString(36).slice(2);
      const key = `${ROOT}${c}/${currentSub}${f.name}`;
      const row = document.createElement("div");
      row.dataset.id = id;
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 80px 1fr 100px";
      row.style.gap = "8px";
      row.innerHTML = `
        <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</div>
        <div style="text-align:right">${(f.size/1024/1024).toFixed(2)} MB</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:8px;background:#eee;border-radius:6px;overflow:hidden">
            <div class="bar" style="height:100%;width:0%;background:#4caf50"></div>
          </div>
          <span class="state" style="font-size:12px;color:#555">In coda…</span>
        </div>
        <div style="text-align:right"><button class="btn btn-muted btn-sm">Annulla</button></div>`;
      queueList.appendChild(row);
      queue.push({id,key,file:f,row,state:"pending"});
    }
  }

  document.getElementById("startUpload").onclick = async () => {
    if(!queue.some(q=>q.state==="pending")) return;
    statusEl.textContent = "Upload in corso...";
    for(const q of queue){
      q.state="running";
      const pres = await fetch(`${SIGNER_BASE}/api/presign-put`, {method:"POST", headers:HJSON, body: JSON.stringify({key:q.key, contentType:q.file.type||"application/octet-stream"})}).then(r=>r.json());
      if(!pres || !pres.url){ q.state="error"; markErr(q); continue; }
      await new Promise((res,rej)=>{
        const xhr=new XMLHttpRequest();
        xhr.open("PUT", pres.url);
        xhr.setRequestHeader("Content-Type", q.file.type||"application/octet-stream");
        xhr.upload.onprogress = e => { if(e.lengthComputable){ q.row.querySelector(".bar").style.width = (e.loaded/e.total*100)+"%"; }};
        xhr.onload = () => xhr.status<300?res():rej();
        xhr.onerror = rej;
        xhr.send(q.file);
      }).then(()=>{
        q.state="done"; markDone(q);
      }).catch(()=>{
        q.state="error"; markErr(q);
      });
    }
    statusEl.textContent="Upload completato ✅";
    setTimeout(()=>{queueList.innerHTML=""; queue=[]; queueWrap.style.display="none"; listFiles();},1000);
  };

  function markDone(q){
    q.row.querySelector(".bar").style.background="#2e7d32";
    q.row.querySelector(".state").textContent="Completato";
    q.row.querySelector(".state").style.color="#2e7d32";

    // CLONE SILENZIOSO: se caricato in PROGRAMMARE -> copia anche in ARCHIVIO
    if (q.key.includes("/VIDEO_DA_PROGRAMMARE/")) {
      fetch(`${SIGNER_BASE}/api/clone-to-archive`, {
        method: "POST",
        headers: {"x-agency-token": TOKEN, "Content-Type":"application/json"},
        body: JSON.stringify({ key: q.key })
      }).catch(()=>{});
    }
  }

  function markErr(q){
    q.row.querySelector(".bar").style.background="#c62828";
    q.row.querySelector(".state").textContent="Errore";
    q.row.querySelector(".state").style.color="#c62828";
  }

  loadClients();
  listFiles();
</script>
</body>
</html>
