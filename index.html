<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gestione Video clienti Aagency</title>
  <style>
    .aag-wrap { font:14px system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width:1100px; margin:18px auto; }
    .aag-head { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; margin-bottom:18px; }
    .aag-h1 { margin:0; font-size:22px; }
    .aag-sub { color:#666; font-size:13px; margin-top:4px; }

    .btn { padding:10px 14px; border:none; border-radius:10px; cursor:pointer; background:#000; color:#fff; line-height:1; }
    .btn-sm { padding:8px 12px; border-radius:8px; font-size:13px; }
    .btn:hover { background:#111; }
    .btn-danger { background:#b00020; color:#fff; border:none; }
    .btn-danger:hover { background:#8a0019; }

    .aag-field { padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-height:44px; }
    .aag-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }

    .dropzone {
      flex:1 1 420px; min-height:140px; border:2px dashed #bbb; border-radius:12px;
      display:flex; align-items:center; justify-content:center; padding:18px; text-align:center;
    }
    .dropzone.drag { border-color:#999; }

    .aag-card { border:1px solid #eee; border-radius:10px; padding:12px; }
    .aag-muted { color:#666; }
    .aag-breadcrumb small { color:#999; font-size:12px; margin-left:8px; }

    .aag-tablewrap { overflow:auto; -webkit-overflow-scrolling: touch; border-radius:8px; }
    table { width:100%; border-collapse:collapse; min-width:720px; }
    th, td { padding:8px; border-bottom:1px solid #eee; }

    @media (max-width: 760px) {
      .aag-wrap { margin:10px auto; }
      .aag-head { flex-direction:column; align-items:flex-start; gap:10px; }
      .aag-h1 { font-size:20px; }
      .aag-row { flex-direction:column; align-items:stretch; }
      .aag-row > * { width:100% !important; }
      .btn, .btn-sm { width:100%; }
      .dropzone { min-height:110px; }
      .aag-tablewrap { border:1px solid #f0f0f0; }
    }
  </style>
</head>
<body>
<div class="aag-wrap">

  <div class="aag-head">
    <div>
      <h1 class="aag-h1">Gestione Video dei clienti Aagency</h1>
      <div class="aag-sub">Carica, organizza e condividi video per cliente e cartella operativa.</div>
    </div>
    <button id="toggleHelp" class="btn btn-sm" aria-expanded="false">❓ Mostra guida</button>
  </div>

  <div id="helpPanel" style="display:none;" class="aag-card">
    <div style="font-weight:600; margin-bottom:6px;">Come funziona</div>
    <ol style="margin:0; padding-left:18px; line-height:1.5;">
      <li><b>Cliente</b>: scegli un cliente (autocomplete) o scrivi un nome nuovo e clicca <b>Crea Cliente</b> (crea cartelle standard).</li>
      <li><b>Cartella</b>: seleziona <i>VIDEO_DA_EDITARE</i>, <i>VIDEO_DA_PROGRAMMARE</i> o <i>ARCHIVIO</i>.</li>
      <li><b>Caricamento</b>: trascina i file nell’area o clicca <i>Scegli file</i>, poi <b>Avvia upload</b>. Ogni file ha la sua barra; a fine lavori la coda si svuota da sola.</li>
      <li><b>Lista</b>: usa <i>Aggiorna lista</i> per vedere i file della cartella selezionata.</li>
      <li><b>Azioni</b>: seleziona più file → <i>Scarica selezionati</i> o <i>Elimina selezionati</i>. Singolo file: pulsanti in riga.</li>
      <li><b>Note</b>: i placeholder <code>.keep</code> sono nascosti in UI. <b>Elimina Cliente</b> rimuove <u>tutto</u> il contenuto del cliente.</li>
    </ol>
  </div>

  <div class="aag-row">
    <label>Cliente:</label>
    <input id="client" list="clienti" placeholder="Es. BAR PASTICCERIA ROMA" class="aag-field" style="min-width:280px;">
    <datalist id="clienti"></datalist>

    <button id="createClient" class="btn btn-sm">Crea Cliente</button>
    <button id="deleteClient" class="btn btn-danger btn-sm">Elimina Cliente</button>

    <label>Cartella:</label>
    <select id="sub" class="aag-field">
      <option value="VIDEO_DA_EDITARE/">VIDEO_DA_EDITARE/</option>
      <option value="VIDEO_DA_PROGRAMMARE/">VIDEO_DA_PROGRAMMARE/</option>
      <option value="ARCHIVIO/">ARCHIVIO/</option>
    </select>

    <button id="refresh" class="btn btn-sm">Aggiorna lista</button>
  </div>

  <div class="aag-row" style="align-items:flex-start;">
    <div id="dropzone" class="dropzone">
      <div>
        <div style="font-weight:600;">Trascina qui i file</div>
        <div class="aag-muted" style="font-size:12px; margin:6px 0;">oppure</div>
        <label class="btn btn-sm" style="display:inline-block;">
          Scegli file
          <input type="file" id="file" multiple style="display:none;">
        </label>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px; width:220px;">
      <button id="startUpload" class="btn">Avvia upload</button>
      <span id="status" style="color:#070;"></span>
    </div>
  </div>

  <div id="queue" class="aag-card" style="display:none; margin-bottom:12px;">
    <div style="font-weight:600;margin-bottom:6px;">Coda upload</div>
    <div id="queueList" style="display:flex; flex-direction:column; gap:8px;"></div>
  </div>

  <div class="aag-row" style="margin:6px 0 12px;">
    <label style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="selectAll"> Seleziona tutto
    </label>
    <button id="bulkDownload" class="btn btn-sm">Scarica selezionati</button>
    <button id="bulkDelete" class="btn btn-danger btn-sm">Elimina selezionati</button>
  </div>

  <div id="list" class="aag-card"></div>
</div>

<script>
  /* === CONFIG ===
     IMPORTANTE: essendo UI e API sullo stesso progetto Vercel,
     usiamo l'origine corrente: funziona con vercel.app e con dominio custom. */
  const SIGNER_BASE = window.location.origin;
  const TOKEN = "aagencysocialmediagiavide23";     // il tuo SIGNER_TOKEN
  const ROOT = "Aagency_GestioneVideo/";
  const PARALLEL_LIMIT = 3;

  /* === HELPERS === */
  const HJSON = { "x-agency-token": TOKEN, "Content-Type":"application/json" };
  const H = { "x-agency-token": TOKEN };
  const el = (s) => document.querySelector(s);
  const listDiv = el("#list"), statusEl = el("#status");
  const selectAllEl = el("#selectAll"), bulkDlBtn = el("#bulkDownload"), bulkDelBtn = el("#bulkDelete");
  const dropzone = el("#dropzone"), fileInput = el("#file"), queueWrap = el("#queue"), queueList = el("#queueList");
  const helpBtn = el("#toggleHelp"), helpPanel = el("#helpPanel");
  let queue = [];

  function keyPrefix(client, sub = "") {
    const c = (client || "").trim();
    if (!c) return ROOT;
    return ROOT + c + "/" + (sub || "");
  }
  function formatMB(bytes){ return (bytes/1024/1024).toFixed(2); }

  helpBtn.onclick = () => {
    const open = helpPanel.style.display !== "none";
    helpPanel.style.display = open ? "none" : "block";
    helpBtn.setAttribute("aria-expanded", String(!open));
    helpBtn.textContent = open ? "❓ Mostra guida" : "❌ Nascondi guida";
  };

  async function loadClients() {
    try {
      const url = `${SIGNER_BASE}/api/list?prefix=${encodeURIComponent(ROOT)}`;
      const data = await fetch(url, { headers: H }).then(r => r.json());
      const options = (data.CommonPrefixes || [])
        .map(p => p.Prefix.replace(ROOT, "").replace(/\/$/, ""))
        .filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,'it'));
      el("#clienti").innerHTML = options.map(o => `<option value="${o}"></option>`).join("");
    } catch (e) { console.warn("Autocomplete clienti fallito:", e); }
  }

  function renderList(data, prefix, client, sub) {
    const files = (data.Contents || [])
      .filter(o => o.Key !== prefix)
      .filter(o => !o.Key.endsWith("/.keep"))
      .map(o => ({ key: o.Key.replace(prefix, ""), size: o.Size, lastModified: o.LastModified }));

    const niceClient = client || "(nessun cliente)";
    const niceSub = (sub || "").replace(/\/$/, "");

    let html = `
      <div class="aag-breadcrumb" style="margin-bottom:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <strong>Percorso:</strong>
        <span>${niceClient}${niceSub ? " / " + niceSub : ""}</span>
        <small>(prefisso interno: ${prefix})</small>
      </div>
    `;

    if (!files.length) {
      html += `<div class="aag-muted">Nessun file trovato.</div>`;
    } else {
      html += `<div class="aag-tablewrap">
        <table>
          <thead>
            <tr>
              <th style="width:36px;"></th>
              <th style="text-align:left;">File</th>
              <th style="text-align:right;">MB</th>
              <th style="text-align:left;">Ultima modifica</th>
              <th style="text-align:right;">Azioni</th>
            </tr>
          </thead>
          <tbody>
            ${files.map((f,i)=>`
              <tr style="${i%2? 'background:#fafafa':''}">
                <td style="text-align:center;">
                  <input type="checkbox" class="rowSel" data-file="${encodeURIComponent(f.key)}">
                </td>
                <td>${f.key}</td>
                <td style="text-align:right;">${formatMB(f.size)}</td>
                <td>${new Date(f.lastModified).toLocaleString()}</td>
                <td style="text-align:right;">
                  <button data-dl="${encodeURIComponent(f.key)}" class="btn btn-sm">Scarica</button>
                  <button data-del="${encodeURIComponent(f.key)}" class="btn btn-danger btn-sm">Elimina</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
    }
    listDiv.innerHTML = html;

    selectAllEl.checked = false;
    selectAllEl.onchange = () => { listDiv.querySelectorAll(".rowSel").forEach(cb => cb.checked = selectAllEl.checked); };

    listDiv.querySelectorAll("button[data-dl]").forEach(btn => {
      btn.onclick = async () => {
        const client = el("#client").value.trim();
        const sub = el("#sub").value;
        const p = decodeURIComponent(btn.dataset.dl);
        const fullKey = keyPrefix(client, (sub||"") + p);
        const u = new URL(SIGNER_BASE + "/api/presign-get");
        u.searchParams.set("key", fullKey);
        const d = await fetch(u, { headers: H }).then(r => r.json());
        if (!d.url) return alert("Errore download");
        window.location.href = d.url;
      };
    });

    listDiv.querySelectorAll("button[data-del]").forEach(btn => {
      btn.onclick = async () => {
        if (!confirm("Eliminare il file?")) return;
        const client = el("#client").value.trim();
        const sub = el("#sub").value;
        const p = decodeURIComponent(btn.dataset.del);
        const u = new URL(SIGNER_BASE + "/api/delete");
        u.searchParams.set("key", keyPrefix(client, (sub||"") + p));
        await fetch(u, { method:"DELETE", headers: H });
        await listSub();
      };
    });
  }

  async function list() {
    const client = el("#client").value.trim();
    const prefix = keyPrefix(client, "");
    listDiv.innerHTML = "Carico...";
    const url = `${SIGNER_BASE}/api/list?prefix=${encodeURIComponent(prefix)}`;
    const data = await fetch(url, { headers: H }).then(r => r.json());
    renderList(data, prefix, client, "");
  }
  async function listSub() {
    const client = el("#client").value.trim();
    const sub = el("#sub").value;
    const prefix = keyPrefix(client, sub);
    listDiv.innerHTML = "Carico...";
    const url = `${SIGNER_BASE}/api/list?prefix=${encodeURIComponent(prefix)}`;
    const data = await fetch(url, { headers: H }).then(r => r.json());
    renderList(data, prefix, client, sub);
  }

  el("#createClient").onclick = async () => {
    const client = el("#client").value.trim();
    if (!client) return alert("Inserisci il nome cliente");
    try {
      statusEl.textContent = "Creo cartelle…";
      const res = await fetch(SIGNER_BASE + "/api/create-client", {
        method: "POST",
        headers: HJSON,
        body: JSON.stringify({ client, root: ROOT })
      }).then(r => r.json());
      if (!res.ok) { alert("Errore creazione cliente"); console.error(res); statusEl.textContent = "Errore"; return; }
      statusEl.textContent = "Cliente creato ✅";
      await loadClients();
      await listSub();
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Errore: " + String(e);
      alert("Errore creazione cliente: " + String(e));
    }
  };

  el("#deleteClient").onclick = async () => {
    const client = el("#client").value.trim();
    if (!client) return alert("Inserisci il nome cliente da eliminare");
    const confirmName = prompt(`ATTENZIONE: questa azione elimina TUTTI i file del cliente.\nScrivi esattamente il nome del cliente per confermare:\n\n${client}`);
    if (confirmName === null) return;
    if (confirmName !== client) return alert("Nome non corrisponde. Operazione annullata.");
    try {
      statusEl.textContent = "Elimino cliente…";
      const res = await fetch(SIGNER_BASE + "/api/delete-client", {
        method: "POST",
        headers: HJSON,
        body: JSON.stringify({ client, root: ROOT })
      }).then(r => r.json());
      if (!res.ok) { alert("Errore eliminazione cliente"); console.error(res); statusEl.textContent = "Errore"; return; }
      statusEl.textContent = `Cliente eliminato (${res.deleted} oggetti) ✅`;
      el("#client").value = "";
      listDiv.innerHTML = "";
      await loadClients();
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Errore: " + String(e);
      alert("Errore eliminazione cliente: " + String(e));
    }
  };

  function makeRow(file, id){
    const row = document.createElement('div');
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 90px 1fr 110px';
    row.style.alignItems = 'center';
    row.style.gap = '8px';
    row.innerHTML = `
      <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${file.name}</div>
      <div style="font-size:12px;color:#666;text-align:right;">${formatMB(file.size)} MB</div>
      <div style="display:flex; align-items:center; gap:8px;">
        <div style="flex:1; height:8px; background:#eee; border-radius:6px; overflow:hidden;">
          <div class="bar" style="height:100%; width:0%; background:#4caf50;"></div>
        </div>
        <span class="state" style="font-size:12px; color:#555; min-width:90px;">In coda…</span>
      </div>
      <div style="text-align:right;">
        <button class="btn btn-sm abort" style="background:#444;">Annulla</button>
      </div>
    `;
    row.dataset.id = id;
    return row;
  }
  function updateProgress(id, pct){
    const row = queueList.querySelector(`[data-id="${id}"]`);
    if (row) row.querySelector('.bar').style.width = Math.max(0, Math.min(100, pct)) + '%';
  }
  function markDone(q){
  // UI: come prima
  q.row.querySelector(".bar").style.background="#2e7d32";
  q.row.querySelector(".state").textContent="Completato";
  q.row.querySelector(".state").style.color="#2e7d32";

  // 🔒 CLONE SILENZIOSO: solo se il key contiene VIDEO_DA_PROGRAMMARE
  if (q.key.includes("/VIDEO_DA_PROGRAMMARE/")) {
    fetch(`${window.location.origin}/api/clone-to-archive`, {
      method: "POST",
      headers: {
        "x-agency-token": "aagencysocialmediagiavide23",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ key: q.key })
    }).catch(()=>{}); // ignora errori per non “sporcare” la UI
  }
}
  function markError(id, msg='Errore'){
    const row = queueList.querySelector(`[data-id="${id}"]`);
    if (row) {
      row.querySelector('.bar').style.background = '#c62828';
      row.querySelector('.state').textContent = msg;
      row.querySelector('.state').style.color = '#c62828';
      const abortBtn = row.querySelector('.abort');
      if (abortBtn) { abortBtn.disabled = true; abortBtn.style.opacity = 0.4; }
    }
  }

  async function presignKey(key, contentType){
    const r = await fetch(SIGNER_BASE + "/api/presign-put", {
      method: "POST",
      headers: HJSON,
      body: JSON.stringify({ key, contentType: contentType || "application/octet-stream" })
    });
    return r.json();
  }
  function xhrPut(url, file, onProgress, signal){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("PUT", url);
      xhr.setRequestHeader("Content-Type", file.type || "application/octet-stream");
      xhr.upload.onprogress = (e)=> {
        if (e.lengthComputable) onProgress(Math.round((e.loaded/e.total)*100));
      };
      xhr.onload = ()=> (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error("HTTP "+xhr.status));
      xhr.onerror = ()=> reject(new Error("Network error"));
      if (signal) signal.addEventListener('abort', ()=> xhr.abort());
      xhr.send(file);
    });
  }

  async function processQueue(){
    const running = new Set();

    async function finalizeIfDone(){
      if (!queue.length || queue.every(q => q.state==='done' || q.state==='error' || q.state==='aborted')){
        statusEl.textContent = "Upload completato ✅";
        await listSub();
        await loadClients();
        setTimeout(() => {
          queue = [];
          queueList.innerHTML = '';
          queueWrap.style.display = 'none';
        }, 1200);
      }
    }

    async function next(){
      if (!queue.some(q=>q.state==='pending' || q.state==='running')) {
        return finalizeIfDone();
      }
      while (running.size < PARALLEL_LIMIT) {
        const item = queue.find(q=>q.state==='pending'));
        if (!item) break;
        item.state = 'running';
        running.add(item.id);

        (async () => {
          try {
            const pres = await presignKey(item.key, item.file.type);
            if (!pres.url) throw new Error("Presign fallito");
            await xhrPut(pres.url, item.file, pct => updateProgress(item.id, pct), item.abort);
            item.state = 'done';
            markDone(item.id);
          } catch (e){
            item.state = item.state==='aborted' ? 'aborted' : 'error';
            markError(item.id, item.state==='aborted' ? 'Annullato' : 'Errore');
            console.error("upload error", item.file.name, e);
          } finally {
            running.delete(item.id);
            next();
          }
        })();
      }
    }
    next();
  }

  function addFiles(files){
    const client = el("#client").value.trim();
    const sub = el("#sub").value;
    if (!client){ alert("Inserisci il nome cliente"); return; }
    const arr = [...files];
    if (!arr.length) return;

    queueWrap.style.display = 'block';
    for (const f of arr){
      const id = Math.random().toString(36).slice(2);
      const key = keyPrefix(client, sub + f.name);
      const controller = new AbortController();
      const row = makeRow(f, id);

      row.querySelector('.abort').onclick = ()=> {
        const q = queue.find(x=>x.id===id);
        if (q && (q.state==='pending' || q.state==='running')){
          if (q.state==='running') controller.abort();
          q.state = 'aborted';
          markError(id, 'Annullato');
        }
      };

      queueList.appendChild(row);
      queue.push({ file:f, id, key, abort:controller.signal, state:'pending', progress:0 });
    }
  }

  dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('drag'); });
  dropzone.addEventListener('dragleave', ()=>{ dropzone.classList.remove('drag'); });
  dropzone.addEventListener('drop', (e)=>{
    e.preventDefault();
    dropzone.classList.remove('drag');
    addFiles(e.dataTransfer.files);
  });
  fileInput.addEventListener('change', (e)=> addFiles(e.target.files));

  el("#startUpload").onclick = async ()=>{
    if (!queue.some(q=>q.state==='pending')) { statusEl.textContent = "Nessun file in coda"; return; }
    statusEl.textContent = "Upload in corso…";
    processQueue();
  };

  function getSelectedKeys() {
    const client = el("#client").value.trim();
    const sub = el("#sub").value;
    const rows = [...listDiv.querySelectorAll(".rowSel:checked")];
    return rows.map(cb => keyPrefix(client, (sub||"") + decodeURIComponent(cb.dataset.file)));
  }

  el("#bulkDownload").onclick = async () => {
    const keys = getSelectedKeys();
    if (!keys.length) return alert("Seleziona almeno un file.");
    statusEl.textContent = `Preparo ${keys.length} download…`;
    for (const key of keys) {
      const u = new URL(SIGNER_BASE + "/api/presign-get");
      u.searchParams.set("key", key);
      const d = await fetch(u, { headers: H }).then(r => r.json());
      if (d.url) {
        const a = document.createElement('a');
        a.href = d.url;
        a.download = '';
        document.body.appendChild(a);
        a.click();
        a.remove();
        await new Promise(r => setTimeout(r, 200));
      }
    }
    statusEl.textContent = "Download avviati ✅";
  };

  el("#bulkDelete").onclick = async () => {
    const keys = getSelectedKeys();
    if (!keys.length) return alert("Seleziona almeno un file.");
    if (!confirm(`Eliminare ${keys.length} file?`)) return;
    statusEl.textContent = `Elimino ${keys.length} file…`;
    for (const key of keys) {
      const u = new URL(SIGNER_BASE + "/api/delete");
      u.searchParams.set("key", key);
      await fetch(u, { method:"DELETE", headers: H });
    }
    await listSub();
    statusEl.textContent = "Eliminati ✅";
  };

  el("#refresh").onclick = () => { const s = el("#sub").value; return s ? listSub() : list(); };

  loadClients().then(list);
</script>
</body>
</html>
